<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Print Ready ID Cards</title>
    <style>
        /* Basic styles for printing on an A4 sheet */
        @page {
            size: A4;
            margin: 10mm;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        .page-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-content: flex-start;
        }
        .card {
            position: relative;
            width: 85.6mm;
            height: 54mm;
            border: 1px dashed #cccccc;
            margin: 2mm;
            box-sizing: border-box;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .element {
            position: absolute;
            box-sizing: border-box;
            white-space: nowrap;
        }
        .element img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        @media print {
            .card {
                border: none;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <% students.forEach(student => { %>
            <div class="card" style="background-image: url('<%- design.backgroundImage ? design.backgroundImage.replace(/url\(['"]?(.*?)['"]?\)/i, '$1') : 'none' %>');">

                <% design.elements.forEach(element => { %>
                    <%
                        // ===== ✨ FINAL, CORRECTED REPLACEMENT LOGIC ✨ =====
                        let finalDisplay = '';
                        const placeholder = element.content || '';
                        const label = element.label || '';

                        // Step 1: Find the actual data value
                        let dataValue = '';
                        if (placeholder.includes('school.logo')) {
                            dataValue = school.logo || '';
                        } else {
                            const keyMatch = placeholder.match(/student\.(\w+)/);
                            if (keyMatch) {
                                const key = keyMatch[1];
                                if (student[key] !== undefined && student[key] !== null) {
                                    if (key === 'dob') { // Special formatting for DOB
                                        try {
                                            const date = new Date(student.dob);
                                            dataValue = `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`;
                                        } catch(e) { dataValue = ''; }
                                    } else {
                                        dataValue = student[key];
                                    }
                                }
                            }
                        }
                        
                        // Step 2: Construct the final string based on type and label
                        if (element.type === 'text') {
                            if (label) { // If it's a field with a label (e.g., "Student Name")
                                finalDisplay = `${label} - ${dataValue}`;
                            } else { // If it's just custom text without a label
                                finalDisplay = dataValue || placeholder.replace(/{{.*?}}|/g, ''); 
                            }
                        } else { // For images
                            finalDisplay = dataValue;
                        }
                    %>

                    <div class="element" style="
                        top: <%= element.y %>px;
                        left: <%= element.x %>px;
                        width: <%= element.width %>;
                        height: <%= element.height %>;
                        font-family: '<%= element.fontFamily %>';
                        font-size: <%= element.fontSize %>;
                        font-weight: <%= element.fontWeight || 'normal' %>;
                        font-style: <%= element.fontStyle || 'normal' %>;
                        text-decoration: <%= element.textDecoration || 'none' %>;
                        color: <%= element.color %>;
                    ">
                        <% if (element.type === 'text') { %>
                            <span><%- finalDisplay %></span>
                        <% } else if (element.type === 'image') { %>
                            <img src="<%- finalDisplay %>" alt="Photo" style="<%- element.shape === 'circle' ? 'border-radius: 50%;' : '' %>">
                        <% } %>
                    </div>
                <% }) %>
            </div>
        <% }) %>
    </div>
</body>
</html>